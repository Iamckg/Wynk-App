@RestResource(urlMapping='/CalendardateuserApi/*')
global class Calendar_date_user_Api {
    @HttpPost
    global static void getHomeList(String UserId, String Startdate) {
        Map<String, Object> response = new Map<String, Object>();

        try {
            Date StartDate1 = Date.valueOf(Startdate);
            // Create a list to store filtered data
            List<Map<String, Object>> homeList = new List<Map<String, Object>>();

            // Query Friend__c records for the specified user
            List<Friend__c> friendList = [SELECT Id, Name, FirstName__c, Last_Name__c, Phone__c, Label__r.Name, Customer__c  FROM Friend__c WHERE Customer__c = :UserId];

            for (Friend__c friend : friendList) {
                Map<String, Object> customerData = new Map<String, Object>();
                customerData.put('Label', friend.Label__r.Name);
                customerData.put('LastName', friend.Last_Name__c);
                customerData.put('FirstName', friend.FirstName__c);
                customerData.put('AccountId', friend.Name);

                // Query Calendar__c records for each friend
                List<Calendar__c> calendarList = [SELECT Id, Start_Date__c, isTentative__c, Type__c, SaveDate__c, Title__c, Customer__r.Id, Moving_Date__c FROM Calendar__c
                    WHERE Customer__c = :friend.Name AND Start_Date__c = :StartDate1];

                List<Map<String, Object>> friendCalendars = new List<Map<String, Object>>();
                for (Calendar__c cal : calendarList) {
                    Map<String, Object> calendarData = new Map<String, Object>();
                    calendarData.put('Type', cal.Type__c);
                    calendarData.put('Tentative', cal.isTentative__c);
                    calendarData.put('MovingDate', cal.Moving_Date__c);
                    calendarData.put('Title', cal.Title__c);
                    calendarData.put('SaveDate', cal.SaveDate__c);
                    calendarData.put('StartDate', cal.Start_Date__c);
                    calendarData.put('CalendarId', cal.Id);
                    calendarData.put('UserId', cal.Customer__r.Id);
                    friendCalendars.add(calendarData);
                }

                customerData.put('Calendars', friendCalendars);
                homeList.add(customerData);
            }

            // Query the labels associated with the given UserId
            List<Label__c> labelList = [SELECT Id, Name
                FROM Label__c
                WHERE Customer__c = :UserId];

            // Create a list to store label names
            List<String> labelNames = new List<String>();

            for (Label__c label : labelList) {
                labelNames.add(label.Name);
            }

            response.put('HomeList', homeList);
            response.put('Labels', labelNames);
            response.put('Status', 'Success');
        } catch (Exception ex) {
            response.put('Status', 'Failed');
            response.put('message', ex.getMessage());
        }

        String jsonResponse = JSON.serialize(response);

        // Return the JSON response
        RestContext.response.addHeader('Content-Type', 'application/json');
        RestContext.response.responseBody = Blob.valueOf(jsonResponse);
    }
}
